
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Gerenciando transações de banco de dados &mdash; Django v1.3.1 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.3.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Django v1.3.1 documentation" href="../../index.html" />
    <link rel="up" title="Models e bancos de dados" href="index.html" />
    <link rel="next" title="Multiple databases" href="multi-db.html" />
    <link rel="prev" title="Performing raw SQL queries" href="sql.html" />
 
<script type="text/javascript" src="../../templatebuiltins.js"></script>
<script type="text/javascript">
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);
</script>

  </head>
  <body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../../index.html">Django v1.3.1 documentation</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../../index.html">Home</a>  |
        <a title="Tabela de conteúdos" href="../../contents.html">Tabela de conteúdos</a>  |
        <a title="Índice Global" href="../../genindex.html">Índice</a>  |
        <a title="Busca" href="../../py-modindex.html">Módulos</a>
      </div>
      <div class="nav">
    &laquo; <a href="sql.html" title="Performing raw SQL queries">previous</a> 
     |
    <a href="../index.html" title="Usando o Django" accesskey="U">up</a>
   |
    <a href="multi-db.html" title="Multiple databases">next</a> &raquo;</div>
    </div>
    
    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="topics-db-transactions">
            
  <div class="section" id="s-module-django.db.transaction">
<span id="s-gerenciando-transacoes-de-banco-de-dados"></span><span id="module-django.db.transaction"></span><span id="gerenciando-transacoes-de-banco-de-dados"></span><h1>Gerenciando transações de banco de dados<a class="headerlink" href="#module-django.db.transaction" title="Permalink to this headline">¶</a></h1>
<p>O Django dá a você poucos caminhos para controlar como as transações de banco de
dados são gerenciadas, isso se você estiver usando um banco de dados que suporta
transações.</p>
<div class="section" id="s-comportamento-padrao-de-transacoes-com-django">
<span id="comportamento-padrao-de-transacoes-com-django"></span><h2>Comportamento padrão de transações com Django<a class="headerlink" href="#comportamento-padrao-de-transacoes-com-django" title="Permalink to this headline">¶</a></h2>
<p>O comportamento padrão do Django é executar com uma transação aberta que ele
comita automaticamente quando quaisquer função interna que modifique a base
de dados for chamada. Por exemplo, se você chamar <tt class="docutils literal"><span class="pre">model.save()</span></tt> ou <tt class="docutils literal"><span class="pre">model.delete()</span></tt>,
a mudança vai ser realizada imediatamente.</p>
<p>Isso parece muito com a configuração auto-commit para a maioria dos bancos
de dados. Tão logo você performe uma ação que precisa escrever no banco
de dados, o Django produz um comando <tt class="docutils literal"><span class="pre">INSERT</span></tt>/<tt class="docutils literal"><span class="pre">UPDATE</span></tt>/<tt class="docutils literal"><span class="pre">DELETE</span></tt> e
então faz um <tt class="docutils literal"><span class="pre">COMMIT</span></tt>. Não há <tt class="docutils literal"><span class="pre">ROLLBACK</span></tt> implícito.</p>
</div>
<div class="section" id="s-amarrando-transacoes-as-requisicoes-http">
<span id="amarrando-transacoes-as-requisicoes-http"></span><h2>Amarrando transações às requisições HTTP<a class="headerlink" href="#amarrando-transacoes-as-requisicoes-http" title="Permalink to this headline">¶</a></h2>
<p>A forma recomendada de lidar com transações em requisições Web é amarrá-las
às fases requisição/resposta através do <tt class="docutils literal"><span class="pre">TransactionMiddleware</span></tt> do Django.</p>
<p>Funciona assim: quando uma requisição é iniciada, o Django começa uma transação.
Se a resposta é produzida sem problemas, o Django commita quaisquer transações
pendentes. Se a função view produz uma exceção, o Django faz um rollback de
quaisquer transações pendentes.</p>
<p>Para ativar esta funcionalidade, apenas adicione o <tt class="docutils literal"><span class="pre">TransactionMiddleware</span></tt>
middleware nos eu setting <tt class="docutils literal"><span class="pre">MIDDLEWARE_CLASSES</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.middleware.cache.UpdateCacheMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.middleware.transaction.TransactionMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.middleware.cache.FetchFromCacheMiddleware&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>A ordem é bastante importante. O middleware de transação se aplica não somente
às funções da view, mas também a todos os módulos middleware que que vem após o
mesmo. Então, se você usar o session middleware após o transaction middleware, a
criação de sessões será parte da transação.</p>
<p>Uma exceção a isso seria o <tt class="docutils literal"><span class="pre">CacheMiddleware</span></tt>, que nunca é afetado. O cache
middleware usa seu próprio cursor de banco de dados (que é mapeado para a sua
própria conexão de banco de dados internamente).</p>
</div>
<div class="section" id="s-controlando-o-gerenciamento-de-transacoes-direto-nas-views">
<span id="s-transaction-management-functions"></span><span id="controlando-o-gerenciamento-de-transacoes-direto-nas-views"></span><span id="transaction-management-functions"></span><h2>Controlando o gerenciamento de transações direto nas views<a class="headerlink" href="#controlando-o-gerenciamento-de-transacoes-direto-nas-views" title="Permalink to this headline">¶</a></h2>
<div class="versionchanged">
<span class="title">Changed in Django 1.3:</span> Transaction management context managers are new in Django 1.3.</div>
<p>Para a maioria das pessoas, transações baseadas em requisições funciona
maravilhosamente bem. Porém, se você precisa de um controle mais fino
sobre como suas transações são gerenciadas, você pode usar um conjunto de funções
do Python em <tt class="docutils literal"><span class="pre">django.db.transaction</span></tt> para controlar transações em nível de
funçãoou por bloco de código.</p>
<p>These functions, described in detail below, can be used in two different ways:</p>
<blockquote>
<div><ul>
<li><p class="first">As a <a class="reference external" href="http://docs.python.org/glossary.html#term-decorator">decorator</a> on a particular function. For example:</p>
<div class="highlight-python"><pre>from django.db import transaction

@transaction.commit_on_success
def viewfunc(request):
    # ...
    # this code executes inside a transaction
    # ...</pre>
</div>
</li>
</ul>
<p>This technique works with all supported version of Python (that is, with
Python 2.4 and greater).</p>
<ul>
<li><p class="first">As a <a class="reference external" href="http://docs.python.org/glossary.html#term-context-manager">context manager</a> around a particular block of code:</p>
<div class="highlight-python"><pre>from django.db import transaction

def viewfunc(request):
    # ...
    # this code executes using default transaction management
    # ...

    with transaction.commit_on_success():
        # ...
        # this code executes inside a transaction
        # ...</pre>
</div>
</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">with</span></tt> statement is new in Python 2.5, and so this syntax can only
be used with Python 2.5 and above.</p>
</div></blockquote>
<p>For maximum compatibility, all of the examples below show transactions using the
decorator syntax, but all of the follow functions may be used as context
managers, too.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although the examples below use view functions as examples, these
decorators and context managers can be used anywhere in your code
that you need to deal with transactions.</p>
</div>
<span class="target" id="topics-db-transactions-autocommit"></span><dl class="function">
<dt id="django.db.transaction.autocommit">
<tt class="descname">autocommit</tt>()<a class="headerlink" href="#django.db.transaction.autocommit" title="Permalink to this definition">¶</a></dt>
<dd><p>Use o decorador <tt class="docutils literal"><span class="pre">autocommit</span></tt> para mudar o comportamento padrão de commit de
uma view, independente da configuração global das transações.</p>
<p>Exemplo:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>

<span class="nd">@transaction.autocommit</span>
<span class="k">def</span> <span class="nf">viewfunc</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">....</span>

<span class="nd">@transaction.autocommit</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&quot;my_other_database&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">viewfunc2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">....</span>
</pre></div>
</div>
<p>Within <tt class="docutils literal"><span class="pre">viewfunc()</span></tt>, transactions will be committed as soon as you call
<tt class="docutils literal"><span class="pre">model.save()</span></tt>, <tt class="docutils literal"><span class="pre">model.delete()</span></tt>, or any other function that writes to
the database.  <tt class="docutils literal"><span class="pre">viewfunc2()</span></tt> will have this same behavior, but for the
<tt class="docutils literal"><span class="pre">&quot;my_other_database&quot;</span></tt> connection.</p>
<p>Dentro de <tt class="docutils literal"><span class="pre">viewfunc()</span></tt>, transações serão commitadas o tão logo você chame
<tt class="docutils literal"><span class="pre">model.save()</span></tt>, <tt class="docutils literal"><span class="pre">model.delete()</span></tt>, ou qualquer outra função que escreva
na base de dados. <tt class="docutils literal"><span class="pre">viewfunc2()</span></tt> will have this same behavior, but for the
<tt class="docutils literal"><span class="pre">&quot;my_other_database&quot;</span></tt> connection.</p>
</dd></dl>

<dl class="function">
<dt id="django.db.transaction.commit_on_success">
<tt class="descname">commit_on_success</tt>()<a class="headerlink" href="#django.db.transaction.commit_on_success" title="Permalink to this definition">¶</a></dt>
<dd><p>Utilize o decorador <tt class="docutils literal"><span class="pre">commit_on_success</span></tt> para usar transações únicas para
todo o trabalho feito em uma função:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>

<span class="nd">@transaction.commit_on_success</span>
<span class="k">def</span> <span class="nf">viewfunc</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">....</span>

<span class="nd">@transaction.commit_on_success</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&quot;my_other_database&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">viewfunc2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">....</span>
</pre></div>
</div>
<p>Se a função retorna com sucesso, então o Django irá commitar todo o trabalho
feito na função até aquele ponto. Se a função levanta uma exceção, todavia,
o Django irá fazer um rollback na transação.</p>
</dd></dl>

<dl class="function">
<dt id="django.db.transaction.commit_manually">
<tt class="descname">commit_manually</tt>()<a class="headerlink" href="#django.db.transaction.commit_manually" title="Permalink to this definition">¶</a></dt>
<dd><p>Use o decorador <tt class="docutils literal"><span class="pre">commit_manually</span></tt> se você precisa de um controle
completo sobre as transações. Ele diz ao Django que você mesmo
irá gerenciar a trasação.</p>
<p>Se seu view muda o dado e não executa um <tt class="docutils literal"><span class="pre">commit()</span></tt> ou <tt class="docutils literal"><span class="pre">rollback()</span></tt>, o
Django irá lançar uma exceção <tt class="docutils literal"><span class="pre">TransactionManagementError</span></tt>.</p>
<p>Gerenciamento manual de transações parece com isso:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>

<span class="nd">@transaction.commit_manually</span>
<span class="k">def</span> <span class="nf">viewfunc</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c"># You can commit/rollback however and whenever you want</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="o">...</span>

    <span class="c"># But you&#39;ve got to remember to do it yourself!</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nd">@transaction.commit_manually</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&quot;my_other_database&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">viewfunc2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">....</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="s-requirements-for-transaction-handling">
<span id="s-topics-db-transactions-requirements"></span><span id="requirements-for-transaction-handling"></span><span id="topics-db-transactions-requirements"></span><h2>Requirements for transaction handling<a class="headerlink" href="#requirements-for-transaction-handling" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<span class="title">New in Django 1.3:</span> <a class="reference internal" href="../../releases/1.3.html"><em>Please, see the release notes</em></a></div>
<p>Django requires that every transaction that is opened is closed before
the completion of a request. If you are using <a class="reference internal" href="#django.db.transaction.autocommit" title="django.db.transaction.autocommit"><tt class="xref py py-func docutils literal"><span class="pre">autocommit()</span></tt></a> (the
default commit mode) or <a class="reference internal" href="#django.db.transaction.commit_on_success" title="django.db.transaction.commit_on_success"><tt class="xref py py-func docutils literal"><span class="pre">commit_on_success()</span></tt></a>, this will be done
for you automatically. However, if you are manually managing
transactions (using the <a class="reference internal" href="#django.db.transaction.commit_manually" title="django.db.transaction.commit_manually"><tt class="xref py py-func docutils literal"><span class="pre">commit_manually()</span></tt></a> decorator), you must
ensure that the transaction is either committed or rolled back before
a request is completed.</p>
<p>This applies to all database operations, not just write operations. Even
if your transaction only reads from the database, the transaction must
be committed or rolled back before you complete a request.</p>
</div>
<div class="section" id="s-como-desativar-globalmente-o-gerenciamentod-e-transacoes">
<span id="como-desativar-globalmente-o-gerenciamentod-e-transacoes"></span><h2>Como desativar globalmente o gerenciamentod e transações<a class="headerlink" href="#como-desativar-globalmente-o-gerenciamentod-e-transacoes" title="Permalink to this headline">¶</a></h2>
<p>Controladores obsecados, podem disabilitar totalmente todo gerenciamento de
transações
Control freaks can totally disable all transaction management by setting
<tt class="docutils literal"><span class="pre">DISABLE_TRANSACTION_MANAGEMENT</span></tt> to <tt class="xref docutils literal"><span class="pre">True</span></tt> in the Django settings file.</p>
<p>Se você fizer isso, o Django não irá prover qualquer gerenciamento de transação
automático qualquer. O middleware não irá implicitamente comitar as transações,
e você precisará gerenciar os rollbacks. Isto requer que você mesmo comita as
alterações feitas pelo middleware e algo a mais.</p>
<p>Deste modo, é melhor usar isto em situações onde você precisa rodar o seu
próprio middleware de controle de transações ou fazer algo realmente estranho.
Em quase todas as situações, você se dará melhor usando o comportamento padrão,
ou o middleware, e somente modificar as funções selecionadas caso precise.</p>
</div>
<div class="section" id="s-savepoints">
<span id="s-topics-db-transactions-savepoints"></span><span id="savepoints"></span><span id="topics-db-transactions-savepoints"></span><h2>Savepoints<a class="headerlink" href="#savepoints" title="Permalink to this headline">¶</a></h2>
<p>Um savepoint é um marcador dentro de uma trasação que habilida você a retornar
parte de uma transação, ao invés de toda ela. Os savepoints estão disponíveis
para backends PostgreSQL 8 e Oracle. Outros backends proverão funções savepoint,
mas eles são operações vazias - eles na verdade não fazem nada.</p>
<p>Os savepoints não são usuais especialmente se você estiver usando o
comportamento padrão <tt class="docutils literal"><span class="pre">autocommit</span></tt> do Django. Entretanto, se você estiver
usando <tt class="docutils literal"><span class="pre">commit_on_success</span></tt> ou <tt class="docutils literal"><span class="pre">commit_manually</span></tt>, cada transação aberta
construirá uma série de operações de banco de dados, que aguardarão um commit ou
um rollback. Se você emitir um rollback, a transação inteira é retrocedida. Os
savepoints fornecem um habilidade de executar rollbacks com granularidade fina,
ao invés de um rollback completo que poderia ser executada pelo
<tt class="docutils literal"><span class="pre">transaction.rollback()</span></tt>.</p>
<p>Os savepoints são controlados por três métodos do objeto transação:</p>
<dl class="method">
<dt id="django.db.transaction.transaction.savepoint">
<tt class="descclassname">transaction.</tt><tt class="descname">savepoint</tt>()<a class="headerlink" href="#django.db.transaction.transaction.savepoint" title="Permalink to this definition">¶</a></dt>
<dd><p>Cria um novo savepoint. Este marca um ponto na transação que é tido como um
&quot;bom&quot; estado.</p>
<p>Retorna o ID do savepoint (sid).</p>
</dd></dl>

<dl class="method">
<dt id="django.db.transaction.transaction.savepoint_commit">
<tt class="descclassname">transaction.</tt><tt class="descname">savepoint_commit</tt>(<em>sid</em>)<a class="headerlink" href="#django.db.transaction.transaction.savepoint_commit" title="Permalink to this definition">¶</a></dt>
<dd><p>Atualiza o savepoint para incluir quaisquer operações que tenham sido
executadas desde que o savepoint foi criado, ou desde o último commit.</p>
</dd></dl>

<dl class="method">
<dt id="django.db.transaction.transaction.savepoint_rollback">
<tt class="descclassname">transaction.</tt><tt class="descname">savepoint_rollback</tt>(<em>sid</em>)<a class="headerlink" href="#django.db.transaction.transaction.savepoint_rollback" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrocede a transação para o último ponto em que o savepoint foi commitado.</p>
</dd></dl>

<p>O exemplo a seguir demonstra o uso de savepoints:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>

<span class="nd">@transaction.commit_manually</span>
<span class="k">def</span> <span class="nf">viewfunc</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>

  <span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
  <span class="c"># abre a transação agora contentdo a.save()</span>
  <span class="n">sid</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint</span><span class="p">()</span>

  <span class="n">b</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
  <span class="c"># abre a transação agora contendo a.save() e b.save()</span>

  <span class="k">if</span> <span class="n">want_to_keep_b</span><span class="p">:</span>
      <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_commit</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
      <span class="c"># abre a transação que ainda contém a.save() e b.save()</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_rollback</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
      <span class="c"># abre a transação agora contendo somente a.save()</span>

  <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="s-transacoes-no-mysql">
<span id="transacoes-no-mysql"></span><h2>Transações no MySQL<a class="headerlink" href="#transacoes-no-mysql" title="Permalink to this headline">¶</a></h2>
<p>Se você estiver usando o MySQL, suas tabelas podem ou não suportar transações;
isto depende da versão do MySQL e do tipo de tabelas que você está usando. (Para
&quot;tipo de tabela,&quot; significa algo como &quot;InnoDB&quot; ou &quot;MyISAM&quot;.) As peculiaridades
de transações no MySQL são fora do escopo do artigo, mas o site do MySQL tem
<a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/sql-syntax-transactions.html">informações sobre as transações no MySQL</a>.</p>
<p>Se sua instalação do MySQL <em>não</em> suporta transações, então o Django irá
funcionar no modo auto-comit: As consultas serão executadas e comitadas logo que
forem chamadas. Se sua instalação do MySQL <em>suporta</em> transações, o Django irá
manipular as transações como explicado neste documento.</p>
</div>
<div class="section" id="s-manipulando-excecoes-em-transacoes-do-postgresql">
<span id="manipulando-excecoes-em-transacoes-do-postgresql"></span><h2>Manipulando exceções em transações do PostgreSQL<a class="headerlink" href="#manipulando-excecoes-em-transacoes-do-postgresql" title="Permalink to this headline">¶</a></h2>
<p>Quando uma chamada para um cursor do PostgreSQL lança uma exceção (tipicamente
<tt class="docutils literal"><span class="pre">IntegrityError</span></tt>), todo o SQL subsequente na mesma transação irá falhar com o
o erro &quot;current transation is aborted, queries ignored until end of transation
block&quot;, ou seja, &quot;a transação atual foi abortada, consultas ignoradas até o
final do bloco da transação&quot;. Embora seja improvável que o uso de um simples
<tt class="docutils literal"><span class="pre">save()</span></tt> gere uma exceção no POstgreSQL, há outros usos mais avançados que
podem, como o de salvar objetos com campos únicos, salvando usando o flag
force_insert/force_update, ou invocando uma SQL customizada.</p>
<p>Há várias maneiras de se deparar com este tipo de erro.</p>
<div class="section" id="s-rollback-de-transacoes">
<span id="rollback-de-transacoes"></span><h3>Rollback de transações<a class="headerlink" href="#rollback-de-transacoes" title="Permalink to this headline">¶</a></h3>
<p>A primeira opção é retroceder toda a transação. Por exemplo:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c"># Sucesso, mas pode ser desfeita com rollback de transação</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">b</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c"># Could throw exception</span>
<span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c"># sucesso, mas a.save() pode ter sido desfeita</span>
</pre></div>
</div>
<p>Chamando <tt class="docutils literal"><span class="pre">transation.rollback()</span></tt> retrocederá toda a transação. Qualquer
operação de banco de dados não comitada será perdida. Neste exemplo, as mudanças
feitas pelo <tt class="docutils literal"><span class="pre">a.save()</span></tt> poderiam ser perdidas, mesmo que a operação não gere um
erro por si só.</p>
</div>
<div class="section" id="s-rollback-de-savepoints">
<span id="rollback-de-savepoints"></span><h3>Rollback de savepoints<a class="headerlink" href="#rollback-de-savepoints" title="Permalink to this headline">¶</a></h3>
<p>Se você está usando o PostgreSQL 8 ou superior, você pode usar <a class="reference internal" href="#topics-db-transactions-savepoints"><em>savepoints</em></a> para controlar a extensão do rollback. Antes
de realizar uma operação de banco de dados que possa falhar, você pode setar ou
atualizar o savepoint; dessa forma, se a operação falhar, você pode retroceder
uma única operação, ao invés de toda transação. Por exemplo:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c"># Sucesso, e nunca será desfeita pelo rollback do savepoint</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint</span><span class="p">()</span>
    <span class="n">b</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c"># Poderia lançar uma exceção</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_commit</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
<span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_rollback</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c"># Sucesso, e a.save() não será desfeita</span>
</pre></div>
</div>
<p>Neste exemplo, <tt class="docutils literal"><span class="pre">a.save()</span></tt> não será desfeito no caso de <tt class="docutils literal"><span class="pre">b.save()</span></tt> lançar uma
exceção.</p>
</div>
<div class="section" id="s-database-level-autocommit">
<span id="database-level-autocommit"></span><h3>Database-level autocommit<a class="headerlink" href="#database-level-autocommit" title="Permalink to this headline">¶</a></h3>
<p>With PostgreSQL 8.2 or later, there is an advanced option to run PostgreSQL
with <a class="reference internal" href="../../ref/databases.html"><em>database-level autocommit</em></a>. If you use this option,
there is no constantly open transaction, so it is always possible to continue
after catching an exception. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c"># succeeds</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">b</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c"># Could throw exception</span>
<span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="c"># succeeds</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is not the same as the <a class="reference internal" href="#topics-db-transactions-autocommit"><em>autocommit decorator</em></a>. When using database level autocommit
there is no database transaction at all. The <tt class="docutils literal"><span class="pre">autocommit</span></tt> decorator
still uses transactions, automatically committing each transaction when
a database modifying operation occurs.</p>
</div>
</div>
</div>
</div>


          </div>         
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Gerenciando transações de banco de dados</a><ul>
<li><a class="reference internal" href="#comportamento-padrao-de-transacoes-com-django">Comportamento padrão de transações com Django</a></li>
<li><a class="reference internal" href="#amarrando-transacoes-as-requisicoes-http">Amarrando transações às requisições HTTP</a></li>
<li><a class="reference internal" href="#controlando-o-gerenciamento-de-transacoes-direto-nas-views">Controlando o gerenciamento de transações direto nas views</a></li>
<li><a class="reference internal" href="#requirements-for-transaction-handling">Requirements for transaction handling</a></li>
<li><a class="reference internal" href="#como-desativar-globalmente-o-gerenciamentod-e-transacoes">Como desativar globalmente o gerenciamentod e transações</a></li>
<li><a class="reference internal" href="#savepoints">Savepoints</a></li>
<li><a class="reference internal" href="#transacoes-no-mysql">Transações no MySQL</a></li>
<li><a class="reference internal" href="#manipulando-excecoes-em-transacoes-do-postgresql">Manipulando exceções em transações do PostgreSQL</a><ul>
<li><a class="reference internal" href="#rollback-de-transacoes">Rollback de transações</a></li>
<li><a class="reference internal" href="#rollback-de-savepoints">Rollback de savepoints</a></li>
<li><a class="reference internal" href="#database-level-autocommit">Database-level autocommit</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h3>Browse</h3>
  <ul>
    
      <li>Prev: <a href="sql.html">Performing raw SQL queries</a></li>
    
    
      <li>Next: <a href="multi-db.html">Multiple databases</a></li>
    
  </ul>
  <h3>Você está aqui:</h3>
  <ul>
      <li>
        <a href="../../index.html">Django v1.3.1 documentation</a>
        
          <ul><li><a href="../index.html">Usando o Django</a>
        
          <ul><li><a href="index.html">Models e bancos de dados</a>
        
        <ul><li>Gerenciando transações de banco de dados</li></ul>
        </li></ul></li></ul>
      </li>
  </ul>  

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/topics/db/transactions.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
              <h3>Última atualização:</h3>
              <p class="topless">Dec 26, 2011</p>
          </div> 
        
      
    </div>
    
    <div id="ft">
      <div class="nav">
    &laquo; <a href="sql.html" title="Performing raw SQL queries">previous</a> 
     |
    <a href="../index.html" title="Usando o Django" accesskey="U">up</a>
   |
    <a href="multi-db.html" title="Multiple databases">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>